<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Reconciliation Service</title>
    
    <link rel="stylesheet" href="lib/dataTables/media/css/demos.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="lib/jquery.ui/themes/cupertino/ui.all.css" type="text/css" media="screen" title="Cupertino" charset="utf-8">
    <link rel="stylesheet" href="lib/suggest/freebase-controls.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="lib/suggest/jquery.freebase.minitopic.css" type="text/css" media="screen" charset="utf-8">

    <link rel="stylesheet" href="recon.css" type="text/css" media="screen" charset="utf-8">

    <script type="text/javascript" language="javascript" src="lib/json2.js"></script>
    <script type="text/javascript" language="javascript" src="lib/jquery.js"></script>
    <script type="text/javascript" language="javascript" src="lib/jquery.ui/ui/ui.core.js"></script>
    <script type="text/javascript" language="javascript" src="lib/jquery.ui/ui/ui.tabs.js"></script>
    <script type="text/javascript" language="javascript" src="lib/jquery.ui/ui/ui.progressbar.js"></script>
    <script type="text/javascript" language="javascript" src="lib/dataTables/media/js/jquery.dataTables.js"></script>

    <script type="text/javascript" language="javascript" src="lib/suggest/jquery.freebase.minitopic.js"></script>
    <script type="text/javascript" language="javascript" src="lib/suggest/freebase.suggest.js"></script>

    <script type="text/javascript" language="javascript" src="recon.js"></script>
    <script type="text/javascript" language="javascript" src="sampledata.js"></script>
    <script type="text/javascript" language="javascript" charset="utf-8">
        function handleNewSpreadsheet()
        {
            parseSpreadsheet($('#spreadsheet')[0].value)
            //initialize some tracking variables

            $("#spreadsheetInput").hide();
            
            var ambiguityStart = getAmbiguousRowIndex();
            if (ambiguityStart != undefined)
                showAmbiguousRowPrompt(ambiguityStart);
            else
                showConfirmationSpreadsheet();
        }
        function showAmbiguousRowPrompt(startingRowIdx) {
            var headersHTML = "";
            for (var i = 0; i < headers.length; i++)
                headersHTML += "<th>" + headers[i] + "</th>";
            $("#formatDisambiguation table thead tr.headers").html(headersHTML);
            
            var rowHTML = function(row){
                var html = "<tr>";
                for (var i = 0; i < headers.length; i++) {
                    html += "<td>" 
                    var val = row[headers[i]] || "";
                    if (typeof val == "string")
                        html += val;
                    else
                        for (var j = 0; j < val.length; j++)
                            html += val[j] + "<br/>";
                    html += "</td>";
                }
                return html + "</tr>";
            } 
            
            var separateRows = rowHTML(rows[startingRowIdx]);
            for (var i = startingRowIdx + 1; i < rows.length && rows[i][headers[0]] == undefined; i++)
                separateRows += rowHTML(rows[i]);
            $("#separateRows tbody").html(separateRows);

            var combinedRow = clone(rows[startingRowIdx]); // produces a copy of the object
            for (var i = startingRowIdx + 1; i < rows.length && rows[i][headers[0]] == undefined; i++){
                for (var j = 0; j<headers.length; j++){
                    var col = headers[j];
                    if (rows[i][col] == undefined) continue;
                    if (typeof(combinedRow[col]) == "string")
                        combinedRow[col] = [combinedRow[col], rows[i][col]];
                    else
                        combinedRow[col].push(rows[i][col]);
                }
            }

            $("#combineRows tbody").html(rowHTML(combinedRow));
            
            $('#formatDisambiguation table tbody tr:odd').addClass('odd');
            $('#formatDisambiguation table tbody tr:even').addClass('even');
            $("#formatDisambiguation").show();
        }
        function showConfirmationSpreadsheet() {
            var spreadSheetData = {"aoColumns":[], "aaData":[]};
            for (var i = 0; i < headers.length; i++)
                spreadSheetData.aoColumns.push({"sTitle":headers[i]});
            for (var i = 0; i < rows.length; i++){
                var row = [];
                for (var j = 0; j < headers.length; j++){
                    var val = rows[i][headers[j]];
                    if (val == undefined)
                        val = "";
                    if (typeof val != "string")
                        val = "[" + val.join(", ") + "]";
                    row[j] = val;
                }
                debugger;
                spreadSheetData.aaData.push(row);
            }
          
            updateUnreconciledCount();
            spreadSheetData["bAutoWidth"] = false
            spreadSheetData["bSort"] = false
            $("#spreadsheetDiv").html('<table class="display" id="spreadsheetTable"></table>');
            $('#spreadsheetTable').dataTable(spreadSheetData)
            $('#spreadsheetInput').hide();
            $('#spreadsheetPreview').show();
        }
        function continueToReconciliation() {
            $("#spreadsheetPreview").hide();
            var tabs = $("#tabs > ul");
            tabs.tabs();
            tabs.bind("tabsselect", function(event, ui) {
                if(ui.index == 0) manualReconcile();
                else if (ui.index == 1) renderSpreadsheet();
            });
            $("#tabs").show();
            tabs.tabs("select", 0);
            spreadsheetParsed();
            beginAutoReconciliation();
        }

        $(document).ready(function() {
            jQuery.ajaxSettings.cache = true; //keeps jquery from inserting cache-busting timecodes into json requests
            
            setReconciliationURL();
            
            //handle the options panel
            $("#optionsPanel input").each(function(idx, input) {
              $(input).change(function(){
                eval(input.id + '="' + input.value + '"');
              });
              input.value = eval(input.id);
            });
            $("#progressbar").progressbar({value:0});
            $("#find_topic")
                .freebaseSuggest()
                .bind("fb-select", function(e, data) { 
                  handleReconChoice(data.id);
                });
        });
    </script>
</head>
<body id="dt_example">
    <div id='main_app'>
      <div id="spreadsheetInput" class="container">
          <h3>Copy your spreadsheet here:</h3>
          <textarea rows="15" cols="80" name="spreadsheet" id="spreadsheet"></textarea><br/>
          <button onclick="handleNewSpreadsheet()">Parse Spreadsheet</button>
          <button onclick="$('#spreadsheet')[0].value = sampleData">Sample Data</button>
          <p/>
      </div>
    
      <div id="formatDisambiguation" class="container invisible">
          <h3>Which of these is correct?</h3>
          <div class='selection' id='separateRows'>
            <button onclick='$("#formatDisambiguation").hide(); showConfirmationSpreadsheet();'>
              Each row is separate
            </button>
            <table>
              <thead>
                <tr class='headers'></tr>
              </thead>
              <tbody>
                
              </tbody>
            </table>
          </div>

          <div class='selection' id='combineRows'>
            <button onclick='combineRows(); $("#formatDisambiguation").hide(); showConfirmationSpreadsheet();'>
              Combine rows missing the first column
            </button>
            <table>
              <thead>
                <tr class='headers'></tr>
              </thead>
              <tbody>
              
              </tbody>
            </table>
          </div>
      </div>
    
      <div id="spreadsheetPreview" class="container invisible">
          <h3>Does this look right?</h3>
          <div id="spreadsheetDiv" class="container">
          </div>
          <br/>
          <button onclick='$("#spreadsheetInput").show();$("#spreadsheetPreview").hide()'>&lt; Back</button>
          <button style='float:right' onclick='continueToReconciliation();'>Continue &gt;</button>
      </div>
      

      
      <div id="tabs" class="invisible">
          <ul>
              <li><a href="#spreadsheetReconcile"><span>Reconcile Record <span class="manual_count">(0)</span></span></a></li>
              <li><a href="#spreadsheetRender"><span>Retrieve Spreadsheet</span></a></li>
          </ul>



          <div id="spreadsheetReconcile" class="">
              <div class="manualQueueEmpty">
                <div class="nowReconciling">
                  <h3>Everything's working fine automatically</h3>  
                  As the auto-reconciler finds topics that it's unable to reconcile, they will appear here to give you a chance at resolving them
                </div>
                <div class="notReconciling">
                  <h3>All done.</h3>
                  All of your records are now reconciled.  You can retrieve your updated spreadsheet by clicking the tab up above. 
                </div>
              </div>
              
              <div id="reconcileDiv" class="invisible manualReconciliation">
                <div class="currentRecord">
                  <h4>Current Record:</h4>
                  <div id="recordVals">
                  
                  </div>
                </div>
                
                <div class="reconciliationCandidates">
                  <h4>Select one of these Freebase topics:</h4>
                  <table class='manualReconciliationChoices'>
                    <thead></thead>
                    <tbody></tbody>
                  </table>
                  <h4>Or:</h4>
                  <button class="skipButton" onclick="handleReconChoice()">Skip This Item</button>
                  |
                  <label class="findItem" for="find_topic">Search For Another Topic:</label>
                  <input type="text" name="find_topic" id="find_topic">
                </div>
                <div class='clear'></div>
              </div>
          </div>

          <div id="spreadsheetRender" class="container">
              <h3>Copy your updated spreadsheet from here:</h3>
              <textarea rows="15" cols="80" name="outputSpreadSheet" id="outputSpreadSheet"></textarea><br/>
              <p/>
          </div>
      </div>
      <div id="progresscontainer" class="nowReconciling invisible">
        <div id='progressbar'>
          <label>50%</label>
        </div>
      </div>
      
      <a href="#optionsPanel" class='optionsButton' onClick='$("#main_app").hide();$("#optionsPanel").show(); return false;'>Options</a>
    </div>
    <div id="optionsPanel" class='invisible container'>
      <label for="reconciliation_url">Reconciliation URL: </label><input type="text" name="reconciliation_url" value="" id="reconciliation_url" size='60'><br/>
      <label for="freebase_url">Freebase URL: </label><input type="text" name="freebase_url" value="" id="freebase_url" size='60'><br/>
      <button onClick='$("#optionsPanel").hide();$("#main_app").show();'>Ok</button>
    </div>
</body>
</html>